"use strict";angular.module("colorpicker.module",[]).factory("helper",function(){return{closest:function(e,t){for(var r=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;e;){if(r.bind(e)(t))return e;e=e.parentNode}return!1},getOffset:function(e){for(var t=0,r=0;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft+e.scrollLeft,r+=e.offsetTop+e.scrollTop,e=e.offsetParent;return{top:r,left:t}},extend:function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["helper",function(e){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,t,r,o){e/=255,t/=255,r/=255;var a,n,s,l;return s=Math.max(e,t,r),l=s-Math.min(e,t,r),a=0===l?null:s==e?(t-r)/l:s==t?(r-e)/l+2:(e-t)/l+4,a=(a+360)%6*60/360,n=0===l?0:l/s,{h:a||1,s:n,b:s,a:o||1}},HueToRGB:function(e,t,r){return 0>r?r+=1:r>1&&(r-=1),1>6*r?e+(t-e)*r*6:1>2*r?t:2>3*r?e+(t-e)*(2/3-r)*6:e},setColor:function(t){t=t.toLowerCase();for(var r in e.stringParsers){{var o=e.stringParsers[r],a=o.re.exec(t),n=a&&o.parse(a);o.space||"rgba"}if(n)return this.value=this.RGBtoHSB.apply(null,n),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,t,r,o){e||(e=this.value.h,t=this.value.s,r=this.value.b),e*=360;var a,n,s,l,i;return e=e%360/60,i=r*t,l=i*(1-Math.abs(e%2-1)),a=n=s=r-i,e=~~e,a+=[i,l,0,0,l,i][e],n+=[l,i,i,l,0,0][e],s+=[0,0,l,i,i,l][e],{r:Math.round(255*a),g:Math.round(255*n),b:Math.round(255*s),a:o||this.value.a}},toHex:function(e,t,r,o){var a=this.toRGB(e,t,r,o);return"#"+(1<<24|parseInt(a.r)<<16|parseInt(a.g)<<8|parseInt(a.b)).toString(16).substr(1)}}}]).directive("colorpicker",["$document","$compile","Color","helper","$timeout",function(e,t,r,o,a){return{require:"?ngModel",restrict:"A",link:function(n,s,l,i){var c,u,f,p,d,v='<div class="colorpicker dropdown-menu"><div class="clickarea"><div class="colorpicker-saturation"><i><b></b></i></div><div class="colorpicker-hue"><i></i></div><div class="colorpicker-alpha"><i></i></div><div class="colorpicker-color"><div /></div></div><div class="colorpicker-color-value"><div /><input value="{{model}}" /></div></div>',h=angular.element(v),g=r,b=null,m=null,k=l.colorpicker?l.colorpicker:"hex";t(h)(n),u={enabled:"rgba"===k,css:null},u.enabled===!0&&(h.addClass("alpha"),u.css=h.find("div")[2].style),angular.element(document.body).append(h),i&&(i.$render=function(){s.val(i.$viewValue)},n.$watch(l.ngModel,function(){C()})),s.bind("$destroy",function(){h.remove()}),f=h.find(".clickarea div")[0].style,c=h.find(".clickarea div")[4].style,p=h.find("i"),d=h.find("input");var x=function(){try{c.backgroundColor=g[k]()}catch(e){c.backgroundColor=g.toHex()}f.backgroundColor=g.toHex(g.value.h,1,1,1),u.enabled===!0&&(u.css.backgroundColor=g.toHex())},y=function(e){e.stopPropagation(),e.preventDefault();var t=o.closest(e.target,"div");if("colorpicker-saturation"===t.className)m=o.extend({},{maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"});else if("colorpicker-hue"===t.className)m=o.extend({},{maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"});else{if("colorpicker-alpha"!==t.className)return!1;m=o.extend({},{maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"})}m.knob=t.children[0].style,m.left=e.pageX-o.getOffset(t).left,m.top=e.pageY-o.getOffset(t).top,b={left:e.pageX,top:e.pageY}},L=function(e){var t=Math.max(0,Math.min(m.maxLeft,m.left+((e.pageX||b.left)-b.left))),r=Math.max(0,Math.min(m.maxTop,m.top+((e.pageY||b.top)-b.top)));m.knob.left=t+"px",m.knob.top=r+"px",m.callLeft&&g[m.callLeft].call(g,t/100),m.callTop&&g[m.callTop].call(g,r/100),x();var o=g[k]();return s.val(o),i&&n.$apply(i.$setViewValue(o)),!1},M=function(){e.unbind("mousemove",L),e.unbind("mouseup",M)},C=function(e){e&&s.val(e),g.setColor(s.val()),p.eq(0).css({left:100*g.value.s+"px",top:100-100*g.value.b+"px"}),p.eq(1).css("top",100*(1-g.value.h)+"px"),p.eq(2).css("top",100*(1-g.value.a)+"px"),x(),d.val(g[k]())};s.bind("click",function(){C(),h.addClass("colorpicker-visible").css({top:o.getOffset($(s).next()[0]).top+$(s).next()[0].offsetHeight-document.body.scrollTop+"px",left:o.getOffset($(s).next()[0]).left-document.body.scrollLeft+"px"})}),h.bind("mousedown",function(e){$(e.target).is(".colorpicker-color-value input")||(e.stopPropagation(),e.preventDefault())});var T;d.bind("keyup",function(){var e=d.val(),t=g.setColor(e);T&&a.cancel(T),T=a(function(){"undefined"!=typeof t&&C(e)},500)}),h.find(".clickarea div").bind("click",function(e){y(e),L(e)}),h.find(".clickarea div").bind("mousedown",function(t){y(t),e.bind("mousemove",L),e.bind("mouseup",M)}),e.bind("mousedown",function(e){$(e.target).is(".colorpicker-color-value input")||h.hasClass("colorpicker-visible")&&h.removeClass("colorpicker-visible")})}}}]);