/*! Studio-v2 - v2.0.0 - 2013-12-18
* https://github.com/kaltura/player-studio
* Copyright (c) 2013 Kaltura */
"use strict";var cl=function(val){return console.log(val)};window.lang="en-US";var KMCModule=angular.module("KMCModule",["localization","ngRoute","KMC.controllers","KMC.filters","KMC.services","KMC.directives","ui.bootstrap","ngAnimate","LocalStorageModule","KMC.menu"]);KMCModule.config(["$routeProvider","$locationProvider","$httpProvider","$tooltipProvider",function($routeProvider,$locationProvider,$httpProvider,$tooltipProvider){$tooltipProvider.options({placement:"right",appendToBody:!0,popupDelay:800}),$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"];var $http,interceptor=["$q","$injector",function($q,$injector){function success(response){return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),response}function error(response){return $http=$http||$injector.get("$http"),$http.pendingRequests.length<1&&(notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestEnded()),$q.reject(response)}var notificationChannel;return function(promise){return notificationChannel=notificationChannel||$injector.get("requestNotificationChannel"),notificationChannel.requestStarted(),promise.then(success,error)}}];$httpProvider.responseInterceptors.push(interceptor),$locationProvider.html5Mode(!0),$routeProvider.when("/login",{templateUrl:"view/login.html",controller:"LoginCtrl",resolve:{apiService:["apiService",function(apiService){return apiService}],localize:"localize"}}),$routeProvider.when("/list",{templateUrl:"view/list.html",controller:"PlayerListCtrl",resolve:{apiService:["apiService","localStorageService","$location",function(apiService,localStorageService,$location){return ksCheck(apiService,localStorageService,$location)}]}});var ksCheck=function(apiService,localStorageService,$location){var ks=localStorageService.get("ks");return ks?(apiService.setKs(ks),apiService):($location.path("/login"),!1)};$routeProvider.when("/edit/:id",{templateUrl:"view/edit.html",controller:"PlayerEditCtrl",resolve:{PlayerData:["PlayerService","$route","apiService","localStorageService","$location",function(PlayerService,$route,apiService,localStorageService,$location){return ksCheck(apiService,localStorageService,$location),PlayerService.getPlayer($route.current.params.id)}],editProperties:"editableProperties",menuSvc:"menuSvc",localize:"localize",userEntries:["apiService","localStorageService","$location",function(apiService,localStorageService,$location){return ksCheck(apiService,localStorageService,$location),apiService.listMedia()}]}}),$routeProvider.when("/newByTemplate",{templateUrl:"view/new-template.html",controller:"PlayerCreateCtrl",resolve:{templates:["playerTemplates",function(playerTemplates){return playerTemplates.listSystem()}],userId:function(){return"1"}}}),$routeProvider.when("/new",{templateUrl:"view/edit.html",controller:"PlayerEditCtrl",resolve:{PlayerData:["PlayerService","apiService","localStorageService","$location",function(PlayerService,apiService,localStorageService,$location){return ksCheck(apiService,localStorageService,$location),PlayerService.newPlayer()}],editProperties:"editableProperties",menuSvc:"menuSvc",localize:"localize",userEntries:["apiService","localStorageService","$location",function(apiService,localStorageService,$location){return ksCheck(apiService,localStorageService,$location),apiService.listMedia()}]}}),$routeProvider.when("/logout",{resolve:{logout:["localStorageService","apiService","$location",function(localStorageService,apiService,$location){localStorageService.isSupported()&&localStorageService.clearAll(),apiService.unSetks(),$location.path("/login")}]}}),$routeProvider.otherwise({resolve:{res:["localStorageService","$location",function(localStorageService,$location){parent.kmc&&parent.kmc.vars&&parent.kmc.vars.ks&&localStorageService.add("ks",parent.kmc.vars.ks);var ks=localStorageService.get("ks");return ks?$location.path("/list"):$location.path("/login")}]}})}]);var DirectivesModule=angular.module("KMC.directives",["colorpicker.module","ui.select2","ui.sortable"]);DirectivesModule.directive("mcustomScrollbar",["$timeout",function($timeout){return{priority:0,restrict:"AC",controller:["$scope","$element","$attrs",function($scope){$scope.$on("layoutChange",function(){$scope.scroller&&$timeout(function(){$scope.scroller.mCustomScrollbar("update")},500)})}],link:function(scope,element,attr){var options=scope.$eval(attr.mcustomScrollbar),opts={horizontalScroll:!1,mouseWheel:!0,autoHideScrollbar:!0,contentTouchScroll:!0,theme:"dark",advanced:{updateOnBrowserResize:!0,updateOnContentResize:!0}};angular.extend(opts,options),$timeout(function(){"function"==typeof $().mCustomScrollbar&&(scope.scroller=element.mCustomScrollbar(opts))},500)}}}]),DirectivesModule.directive("timeago",[function(){return{scope:{timestamp:"@"},restrict:"CA",link:function(scope,iElement){"function"==typeof $.timeago&&scope.$watch("timestamp",function(newVal){if(newVal){var date=1e3*scope.timestamp;iElement.text($.timeago(date))}})}}}]),DirectivesModule.directive("modelRadio",["menuSvc",function(menuSvc){return{restrict:"EA",replace:!0,templateUrl:"template/formcontrols/modelRadio.html",scope:{model:"=",label:"@",helpnote:"@"},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){var menuData=menuSvc.getControlData($attrs.model);$scope.options=menuData.options}],link:function(scope,element){element.find("input").attr("name",scope.model)}}}]),DirectivesModule.directive("modelColor",function(){return{restrict:"EA",replace:!0,controller:["$scope","$element","$attrs",function($scope,$element,$attrs){"undefined"==typeof $scope.model&&($scope.model=$attrs.initvalue?$attrs.initvalue:"#fff")}],scope:{"class":"@",label:"@",helpnote:"@",model:"="},templateUrl:"template/formcontrols/modalColor.html"}}),DirectivesModule.directive("modelText",function(){return{replace:!0,restrict:"EA",scope:{label:"@",model:"=",icon:"@",helpnote:"@"},compile:function(tElement,tAttr){"true"==tAttr.endline&&tElement.append("<hr/>")},templateUrl:"template/formcontrols/modalText.html"}}),DirectivesModule.directive("select2Data",["menuSvc",function(menuSvc){return{replace:!0,restrict:"EA",scope:{label:"@",model:"=",icon:"@",helpnote:"@",initvalue:"@"},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.selectOpts={},$scope.selectOpts.data=menuSvc.doAction($attrs.source),$attrs.query&&($scope.selectOpts.data.results=[],$scope.selectOpts.query=menuSvc.getAction($attrs.query)),$scope.selectOpts.width=$attrs.width}],templateUrl:"template/formcontrols/select2Data.html",compile:function(tElement,tAttr){return"true"==tAttr.endline&&tElement.append("<hr/>"),"true"==tAttr.showEntriesThumbs&&tElement.find("input").attr("list-entries-thumbs","true"),tAttr.placeholder&&tElement.find("input").attr("data-placeholder",tAttr.placeholder),function(){}}}}]),DirectivesModule.directive("modelEdit",["$modal",function($modal){var modalEditCntrl=["$scope",function($scope){"undefined"==typeof $scope.model&&($scope.model=""),$scope.modelValue=$scope.model}];return{replace:!0,restrict:"EA",scope:{label:"@",helpnote:"@",model:"=",icon:"@"},controller:modalEditCntrl,templateUrl:"template/formcontrols/modelEdit.html",compile:function(tElement,tAttr){return"true"==tAttr.endline&&tElement.append("<hr/>"),function(scope,element,attrs){scope.doModal=function(){var modal=$modal.open({templateUrl:"template/dialog/textarea.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{close:function(result,value){scope.model=value,modal.close(result)},title:attrs.label,message:scope.model}}}})}}}}}]),DirectivesModule.directive("modelTags",["menuSvc",function(menuSvc){return{replace:!0,restrict:"EA",scope:{label:"@",model:"=",helpnote:"@",icon:"@"},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.selectOpts={simple_tags:!0,multiple:!0,tokenSeparators:[","," "]},$scope.selectOpts.tags=menuSvc.doAction($attrs.source)}],templateUrl:"template/formcontrols/modelTags.html",compile:function(tElement,tAttr){return"true"==tAttr.endline&&tElement.append("<hr/>"),function(){}}}}]),DirectivesModule.directive("listEntriesThumbs",function(){return{restrict:"A",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){if("true"==$attrs.listEntriesThumbs){var format=function(player){return player.thumbnailUrl?"<img class='thumb' src='"+player.thumbnailUrl+"'/>"+player.name:player.name};$scope.addOption({formatResult:format,formatSelection:format,escapeMarkup:function(m){return m}})}}]}}),DirectivesModule.directive("modelSelect",["menuSvc",function(menuSvc){return{replace:!0,restrict:"EA",require:"?parentContainer",scope:{label:"@",model:"=",initvalue:"@",helpnote:"@",selectOpts:"@"},compile:function(tElement,tAttr){return"true"==tAttr.endline&&tElement.append("<hr/>"),function($scope,$element,$attrs,controller){if(controller){var pubObj={model:$attrs.model,label:$attrs.label.replace("Location",""),sortVal:menuSvc.getControlData($attrs.model).sortVal};controller.register($scope.model,pubObj),$scope.$watch("model",function(newVal,oldVal){newVal!=oldVal&&controller.update(newVal,oldVal,pubObj)})}var menuData=menuSvc.getControlData($attrs.model);$scope.options=menuData.options}},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.selectOpts||($scope.selectOpts={}),$attrs.showSearch||($scope.selectOpts.minimumResultsForSearch=-1),$scope.options=[],$scope.checkSelection=function(value){return value==$scope.model?!0:"number"==typeof value&&parseFloat($scope.model)==value?!0:!1},$scope.initSelection=function(){return(""==$scope.model||"undefined"==typeof $scope.model)&&($scope.model=$attrs.initvalue),$scope.model},$scope.selectOpts.initSelection=$scope.initSelection(),$scope.uiselectOpts=angular.toJson($scope.selectOpts),this.setOptions=function(optsArr){$scope.options=optsArr}}],templateUrl:"template/formcontrols/modelSelect.html"}}]),DirectivesModule.directive("parentContainer",["sortSvc",function(sortSvc){return{restrict:"A",controller:function(){var cntrl={register:function(container,model){sortSvc.register(container,model)},update:function(newVal,oldVal,model){sortSvc.update(newVal,oldVal,model)}};return cntrl}}}]),DirectivesModule.directive("sortOrder",["sortSvc",function(sortSvc){return{restrict:"EA",replace:!0,scope:{},templateUrl:"template/formcontrols/sortOrder.html",controller:["$scope",function($scope){$scope.getObjects=function(){$scope.containers=sortSvc.getObjects()},$scope.getObjects(),sortSvc.sortScope=$scope,$scope.$on("sortContainersChanged",function(){$scope.getObjects()}),$scope.$watchCollection("containers",function(newVal,oldVal){newVal!=oldVal&&sortSvc.saveOrder($scope.containers)}),$scope.sortableOptions={update:function(){cl($scope.containers)},axis:"y"}}],link:function(){}}}]),DirectivesModule.directive("playerRefresh",["PlayerService","menuSvc",function(PlayerService,menuSvc){return{restrict:"A",link:function($scope,$element,$attrs){if("false"!=$attrs.playerRefresh){var model=$attrs.model;menuSvc.menuScope.$watch(model,function(){PlayerService.playerRefresh($attrs.playerRefresh)})}}}}]),DirectivesModule.directive("infoAction",["menuSvc",function(menuSvc){return{restrict:"EA",replace:"true",controller:["$scope",function($scope){$scope.check=function(action){return menuSvc.checkAction(action)},$scope.btnAction=function(action){menuSvc.doAction(action)}}],scope:{model:"=",btnLabel:"@",btnClass:"@",action:"@",helpnote:"@",label:"@"},templateUrl:"template/formcontrols/infoAction.html"}}]),DirectivesModule.directive("prettyCheckbox",function(){return{restrict:"AC",require:"ngModel",transclude:"element",priority:-100,compile:function(tElement,tAttrs,transclude){var wrapper=angular.element('<div class="prettycheckbox"><a href="#" class=""></a></div>'),clickHandler=wrapper.find("a");return function(scope,iElement,iAttr,ngController){transclude(scope,function(clone){return wrapper.append(clone)}),wrapper.wrap(iElement),iElement.replaceWith(wrapper);var watchProp=(wrapper.find("input").hide(),iAttr.model||"model");clickHandler.on("click","a",function(e){return e.preventDefault(),ngController.$setViewValue(!ngController.$viewValue),!1});var formatter=function(){ngController.$viewValue?$(wrapper).find("a").addClass("checked"):$(wrapper).find("a").removeClass("checked")};ngController.$viewChangeListeners.push(formatter),scope.$eval(watchProp)&&clickHandler.find("a").addClass("checked")}}}}),DirectivesModule.directive("prettyRadio",function(){return{restrict:"AC",priority:1e3,transclude:"element",compile:function(tElement,tAttrs,transclude){return function(scope,iElement,iAttr){var wrapper=angular.element('<span class="clearfix prettyradio"></span>'),clickHandler=wrapper.append('<a href="#" class=""></a>'),watchProp="model";"undefined"!=typeof iAttr.model&&(watchProp=iAttr.model),transclude(scope,function(clone){return wrapper.append(clone)}),iElement.replaceWith(wrapper);var input=wrapper.find("input").hide();clickHandler.on("click","a",function(e){return e.preventDefault(),input.trigger("click"),input.trigger("click"),!1}),scope.$watch(function(){return scope.$eval(watchProp)==input.val()},function(newVal,oldVal){newVal!=oldVal&&$(wrapper).find("a").toggleClass("checked")})}}}}),DirectivesModule.directive("modelCheckbox",function(){return{restrict:"EA",templateUrl:"template/formcontrols/modelCheckbox.html",replace:!0,controller:["$scope","$element","$attrs",function($scope,$element,$attrs){(""==$scope.model||"undefined"==typeof $scope.model)&&"true"===$attrs.initvalue&&($scope.model=!0)}],scope:{label:"@",helpnote:"@",model:"="}}}),DirectivesModule.directive("readOnly",["$filter",function($filter){return{restrict:"EA",replace:"true",scope:{model:"=",label:"@",helpnote:"@"},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$attrs.filter&&"function"==typeof $filter($attrs.filter)&&($scope.model=$filter($attrs.filter)($scope.model)),$attrs.initvalue&&("undefined"==typeof $scope.model||""==scope.model)&&($scope.model=$attrs.initvalue)}],templateUrl:"template/formcontrols/readOnly.html"}}]),DirectivesModule.directive("modelButton",["menuSvc",function(menuSvc){return{restrict:"EA",replace:"true",controller:["$scope",function($scope){$scope.check=function(action){return menuSvc.checkAction(action)},$scope.btnAction=function(action){menuSvc.doAction(action)}}],scope:{label:"@",action:"@",btnClass:"@",helpnote:"@"},templateUrl:"template/formcontrols/modelButton.html"}}]),DirectivesModule.directive("modelNumber",function(){return{templateUrl:"template/formcontrols/spinEdit.html",replace:!0,restrict:"EA",scope:{model:"=",helpnote:"@",label:"@"},link:function($scope,$element,$attrs){var $spinner=$element.find("input").spinedit({minimum:parseFloat($attrs.from),maximum:parseFloat($attrs.to),step:parseFloat($attrs.stepsize),value:parseFloat($attrs.initvalue),numberOfDecimals:parseFloat($attrs.numberofdecimals)});$spinner.on("valueChanged",function(e){"number"==typeof e.value&&$scope.$apply(function(){$scope.model=e.value})})},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){var def={from:5,to:10,stepsize:1,numberOfDecimals:0},keys=["from","to","stepsize","numberofdecimals"];angular.forEach(keys,function(keyName){$scope[keyName]=$attrs[keyName]?$attrs[keyName]:def[keyName]}),$scope.initvalue="undefined"!=typeof $scope.model?$scope.model:$attrs["default"]?$attrs["default"]:1}]}}),DirectivesModule.directive("onFinishRender",["$timeout","requestNotificationChannel",function($timeout,requestNotificationChannel){return{restrict:"A",link:function(scope){scope.$last===!0&&$timeout(function(){requestNotificationChannel.requestEnded("list")})}}}]),angular.module("KMC.filters",["ngSanitize"]).filter("HTMLunsafe",["$sce",function($sce){return function(val){return $sce.trustAsHtml(val)}}]).filter("timeago",function(){return function(input){if("function"==typeof $.timeago){var date=1e3*input;return $.timeago(date)}}}).filter("range",function(){return function(input){var lowBound,highBound;switch(input.length){case 1:lowBound=0,highBound=parseInt(input[0])-1;break;case 2:lowBound=parseInt(input[0]),highBound=parseInt(input[1]);break;default:return input}for(var result=[],i=lowBound;highBound>=i;i++)result.push(i);return result}}).filter("startFrom",function(){return function(input,start){return input?(start=+start,input.slice(start)):[]}});var KMCMenu=angular.module("KMC.menu",[]);KMCMenu.controller("menuCntrl",["menuSvc","$scope",function(menuSvc,$scope){var getWidth=function(){return $("#mp-menu").width()},closeMenu=function(){var width=getWidth();$("#mp-pusher").animate({left:"0"},{duration:200,queue:!0}),$("#mp-menu").animate({left:"-"+width}),$("#mp-pusher >.wrapper").animate({width:"100%"})},resetMenu=function(){var width=getWidth();$("#mp-pusher").css({left:width}),$("#mp-menu").css({left:-width})},openMenu=function(){var width=getWidth();$("#mp-pusher").animate({left:width},{duration:200,queue:!0}),$("#mp-menu").animate({left:-width},{duration:200,queue:!1}),$("#mp-pusher >.wrapper").animate({width:"70%"},{duration:200,queue:!0})};$scope.menuShown=!0,resetMenu(),$(window).resize(function(){1==$scope.menuShown?resetMenu():closeMenu()}),$scope.$on("menuChange",function(){$scope.menuShown=!0}),$scope.$watch(function(){return menuSvc.currentPage},function(newVal,oldVal){newVal!=oldVal&&($scope.menuShown||($scope.menuShown=!0))}),$scope.togglemenu=function(e){$scope.menuShown=!$scope.menuShown,$scope.menuShown?$(e.target).parent().css("transform",""):$(e.target).parent().css("transform","rotate(180deg)")},$scope.$watch("menuShown",function(newVal,oldVal){newVal!=oldVal&&(newVal?openMenu():closeMenu())})}]),KMCMenu.factory("menuSvc",["editableProperties",function(editableProperties){var menudata=null,promise=editableProperties.success(function(data){menudata=data}),JSON2directiveDictionary=function(jsonName){switch(jsonName){case"modaledit":return"<div model-edit/>";case"tags":return"<div model-tags/>";case"select2data":return"<div select2-data/>";case"dropdown":return"<div model-select/>";case"container":return'<div model-select parent-container=""/>';case"checkbox":return"<div model-checkbox/>";case"color":return"<div model-color/>";case"text":return"<div model-text/>";case"number":return"<div model-number/>";case"readonly":return"<div read-only/>";case"featuremenu":return"<div feature-menu/>";case"radio":return"<div model-radio/>";case"button":return"<div model-button/>";case"infoAction":return"<div info-action/>";case"sortOrder":return"<div sort-order/>"}},searchGet=function(obj,target){return"undefined"!=typeof obj[target]?obj[target]:void 0},search=function(path,obj,target){for(var k in obj)if(obj.hasOwnProperty(k)&&("label"==k||"children"==k||"object"==typeof obj[k])){if(obj[k]==target)return path+"['"+k+"']";if("object"==typeof obj[k]||"Array"==typeof obj[k]){var result=search(path+"['"+k+"']",obj[k],target);if(result)return result}}return!1},Search4ControlModelData=function(path,obj,target){for(var k in obj)if(obj.hasOwnProperty(k)&&("label"==k||"children"==k||"object"==typeof obj[k])){if("undefined"!=typeof obj[k].model&&obj[k].model==target)return obj[k];if("object"==typeof obj[k]){var result=Search4ControlModelData(path+"['"+k+"']",obj[k],target);if(result)return result}}return!1},menuSvc={promise:promise,menuScope:{},get:function(){return menudata},getModalData:function(model){return searchGet(menuSvc.menuScope,model)},getControlData:function(model){var modelStr=model.substr(model.indexOf(".")+1);return Search4ControlModelData("",menudata,modelStr)},currentPage:"",setMenu:function(setTo){menuSvc.currentPage=setTo,menuSvc.menuScope.$parent.$broadcast("menuChange",setTo)},buildMenu:function(baseData){var menuJsonObj=menuSvc.get(),menuElm=angular.element("<ul></ul>");return angular.forEach(menuJsonObj,function(value){menuElm.append(menuSvc.buildMenuItem(value,menuElm,baseData))}),menuElm},buildMenuItem:function(item,targetMenu,BaseData,parentModel){function writeChildren(item,parent,eachInLi){for(var j=0;j<item.children.length;j++){var subitem=item.children[j];switch(subitem.type){case"menu":parent.append(menuSvc.buildMenuItem(subitem,parent,item.model,item));break;case"featuremenu":parent.append(writeChildren(subitem,writeFormElement(subitem,"<div feature-menu/>")));break;default:var directive=JSON2directiveDictionary(subitem.type);directive&&parent.append(writeFormElement(subitem,directive))}}return 1==eachInLi&&parent.children().each(function(){$(this).is("menu-level")||$(this).wrap("<li>")}),parent}function writeFormElement(item,directive){var elm=angular.element(directive);return elm.attr("model","data."+item.model),angular.forEach(item,function(value,key){"model"==key||"string"!=typeof value&&"number"!=typeof value&&"boolean"!=typeof value||elm.attr(key,value)}),elm}var elm="";switch(item.type){case"menu":var menuLevelObj=angular.element('<div menu-level pagename="'+item.model+'" />');"undefined"!=typeof parentModel&&(menuLevelObj.attr("parent-label",parentModel.label),menuLevelObj.attr("parent-page",parentModel.model));var parentMenu=writeFormElement(item,menuLevelObj);elm=writeChildren(item,parentMenu,!0);break;case"featuremenu":elm=writeChildren(item,writeFormElement(item,"<div feature-menu/>"));break;default:var directive=JSON2directiveDictionary(item.type);directive&&(elm=writeFormElement(item,directive))}return elm},menuSearch:function(searchValue){var foundLabel=search("menudata",menudata,searchValue);if(!foundLabel)return!1;var foundModel=eval(foundLabel.substr(0,foundLabel.lastIndexOf("['label']"))).model,lastChild=foundLabel.lastIndexOf("['children']"),lastMenu=foundLabel.substr(0,lastChild),menuPage=eval(lastMenu),featureMenu=[];if("object"==typeof menuPage){if("featuremenu"==menuPage.type)for(;"object"==typeof menuPage&&"featuremenu"==menuPage.type;)featureMenu.push(menuPage),lastChild=lastMenu.lastIndexOf("['children']"),menuPage=eval(lastMenu.substr(0,lastChild)),lastMenu=foundLabel.substr(0,lastChild);return menuSvc.menuScope.$broadcast("highlight",foundModel),menuSvc.setMenu(menuPage.model),featureMenu.length&&angular.forEach(featureMenu,function(value){menuSvc.menuScope.$broadcast("openFeature",value.model)}),!0}},actions:[],registerAction:function(callStr,dataFn,context){"function"==typeof dataFn?menuSvc.actions[callStr]=context?{applyOn:context,funcData:dataFn}:dataFn:"object"==typeof dataFn&&(menuSvc.actions[callStr]={applyOn:dataFn,funcData:function(){return dataFn}})},doAction:function(action,arg){if("function"==typeof menuSvc.actions[action])return menuSvc.actions[action].call(arg);if("object"==typeof menuSvc.actions[action]&&"function"==typeof menuSvc.actions[action].funcData){var retData=menuSvc.actions[action].funcData.apply(menuSvc.actions[action].applyOn,arg);return retData}},getAction:function(action){return menuSvc.actions[action]},checkAction:function(action){return"function"==typeof menuSvc.actions[action]?!0:!1}};return menuSvc}]).directive("featureMenu",["$parse",function($parse){return{restrict:"EA",replace:!0,templateUrl:"template/menu/featureMenu.html",transclude:!0,controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.label=$attrs.label,$scope.helpnote=$attrs.helpnote,$scope.featureCheckbox="false"==$attrs.featureCheckbox?!1:!0,$scope.featureCheckbox&&($scope.modelPath=$attrs.model+"._featureEnabled",$scope.featureModelCon=$parse($scope.modelPath),$scope.featureModel=$scope.featureModelCon($scope)),$scope.id=$attrs.model.replace(/\./g,"_")}],scope:!0,compile:function(tElement,tAttr,transclude){return"false"!=tAttr.endline&&tElement.append("<hr/>"),function(scope,element,attributes){scope.$watch("featureModel",function(newVal,oldVal){newVal!=oldVal&&(scope.featureModelCon.assign(scope,newVal),newVal&&element.find(".collapse").length>0&&element.find("#"+scope.id).collapse("toggle"))}),transclude(scope,function(clone){element.find("ng-transclude").replaceWith(clone)}),element.on("show.bs.collapse hide.bs.collapse",function(e){e.target.id==scope.id&&$(this).find(".header:first i.glyphicon").toggleClass("rotate90")}),scope.$on("openFeature",function(e,args){args==attributes.highlight&&element.find("#"+scope.id).collapse("show")})}}}}]).directive("model",["$timeout",function($timeout){return{restrict:"A",link:function(scope,iElem,iAttr){scope.$on("highlight",function(e,data){if(iAttr.model.replace("data.","")==data){var elm=iElem;iElem.parent().is("li")&&(elm=iElem.parent());var originalBG=elm.css("background")||"transparent";elm.css({backgroundColor:"rgba(253,255,187,1)"}),$timeout(function(){elm.animate({backgroundColor:"rgba(253,255,187,0)"},1e3,function(){elm.css({backgroundColor:originalBG},1e3)})},4e3)}})}}}]).directive("navmenu",["menuSvc","$compile","$timeout",function(menuSvc,$compile,$timeout){return{templateUrl:"template/menu/navmenu.html",replace:!0,restrict:"EA",scope:{data:"="},transclude:!0,compile:function(tElement){var menuElem=tElement.find("ul[ng-transclude]:first"),menuData=menuSvc.buildMenu("data");return function($scope,$element){$compile(menuData.contents())($scope,function(clone){menuElem.prepend(clone)}),$scope.$on("menuChange",function(e,page){$element.find(".mCustomScrollbar").mCustomScrollbar("destroy"),"search"!=page&&$timeout(function(){$element.find(".mp-level-open:last").mCustomScrollbar({set_height:"100%"})},500)}),$timeout(function(){menuSvc.setMenu("basicDisplay")},500)}},controller:["$scope","$element",function($scope,$element){$element.on("shown.bs.collapse hidden.bs.collapse",function(){$(".mCustomScrollbar").mCustomScrollbar("update")}),menuSvc.menuScope=$scope}]}}]).controller("menuSearchCtl",["$scope","menuSvc",function($scope,menuSvc){var menuObj=menuSvc.get();$scope.menuData=[],$scope.checkSearch=function(val){val&&console.log(val),$scope.notFound=!1,$scope.menuSearch&&$scope.searchMenuFn()},$scope.menuSearch="",$scope.searchMenuFn=function(){var searchResult=menuSvc.menuSearch($scope.menuSearch);searchResult?$scope.menuSearch="":$scope.notFound=!0};var getLabels=function(obj){angular.forEach(obj,function(value){$scope.menuData.push(value.label),value.children&&getLabels(value.children)})};getLabels(menuObj)}]).directive("menuLevel",["menuSvc",function(menuSvc){return{templateUrl:"template/menu/menuPage.html",replace:!0,transclude:"true",restrict:"EA",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.selfOpenLevel=function(){menuSvc.setMenu($attrs.pagename)},$scope.goBack=function(){menuSvc.setMenu($attrs.parentPage)},$scope.openLevel=function(arg){return $scope.isOnTop="undefined"==typeof arg?!0:arg==$scope.pagename?!0:!1},$scope.isOnTop=!1}],compile:function(tElement,tAttr){return"true"==tAttr.endline&&tElement.find("div.menu-level-trigger").append("<hr/>"),function($scope,$element){$scope.$on("menuChange",function(event,arg){$scope.openLevel(arg)}),$scope.$watch("isOnTop",function(newVal){newVal?($element.parents('.mp-level:not("#mp-base")').addClass("mp-level-in-stack"),$element.children(".mp-level:first").addClass("mp-level-open").removeClass("mp-level-in-stack")):($element.children(".mp-level:first").removeClass("mp-level-open"),$element.parents('.mp-level.mp-level-in-stack:not("#mp-base")').removeClass("mp-level-open mp-level-in-stack"))})}},scope:{label:"@",pagename:"@",parentPage:"@",parentLabel:"@",description:"@"}}}]).directive("menuHead",["menuSvc",function(menuSvc){return{restrict:"EA",template:"<div id='mp-mainlevel'><ul></ul></div>",replace:!0,transclude:!0,scope:{},controller:["$scope","$element",function($scope){$scope.changeActiveItem=function(element){var menuitem=$(element);menuitem.length&&menuitem.is("a")&&menuitem.parent("li")&&($(menuitem).addClass("active"),$(menuitem).parent("li").siblings("li").find("a").removeClass("active"))}}],compile:function(tElement,attr,transclude){var ul=tElement.find("ul"),elements=menuSvc.get();return angular.forEach(elements,function(value,key){var elm=angular.element("<li></li>");elm.html('<a menupage="'+value.model+'" class="icon icon-'+value.icon+'" tooltip-placement="right" tooltip="'+value.label+'"></a>'),0==key&&elm.find("a").addClass("active"),elm.appendTo(ul)}),function($scope,$element){transclude($scope,function(transItem){ul.prepend(transItem)}),$element.find("a[menupage]").each(function(){$(this).click(function(){var model=$(this).attr("menupage");menuSvc.setMenu(model),$scope.changeActiveItem(this)})})}}}}]),KMCModule.controller("LoginCtrl",["$scope","apiService","$location","localStorageService","requestNotificationChannel",function($scope,apiService,$location,localStorageService,requestNotificationChannel){requestNotificationChannel.requestEnded("list"),$scope.formError=!0,$scope.formHelpMsg="You must login to use this application",$scope.email="",$scope.pwd="",$scope.login=function(){apiService.doRequest({service:"user",action:"loginbyloginid",loginId:$scope.email,password:$scope.pwd}).then(function(data){localStorageService.isSupported()&&localStorageService.add("ks",data),apiService.setKs(data),$location.path("/list")},function(errorMsg){$scope.formError=!0,$scope.formHelpMsg=errorMsg})}}]),angular.module("KMC.controllers",[]).controller("ModalInstanceCtrl",["$scope","$modalInstance","settings",function($scope,$modalInstance,settings){$scope.title="",$scope.message="",$scope.buttons=[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:"OK",cssClass:"btn-primary"}],$scope.close=function(result){$modalInstance.close(result)},$scope.cancel=function(){$modalInstance.dismiss("cancel")},angular.extend($scope,settings)}]),KMCModule.controller("PlayerCreateCtrl",["$scope","$filter","templates","userId","playerTemplates",function($scope,$filter,templates,userId,playerTemplates){$scope.title=$filter("i18n")("New player - from template"),$scope.templates=templates.data,$scope.templateType="system",$scope.userId=userId,$scope.loading=!1,$scope.$watch("templateType",function(newVal,oldVal){newVal!=oldVal&&("user"==newVal?($scope.loading=!0,playerTemplates.listUser($scope.userID).success(function(response){$scope.templates=response,$scope.loading=!1})):($scope.loading=!0,$scope.templates=templates.data,$scope.loading=!1))}),$scope.makeTooltip=function(index){var item=$scope.templates[index];return item&&"undefined"!=typeof item.settings&&"undefined"!=typeof item.settings.name?item.settings.name+"<br/>"+item.id+"<br/> Any information you will decide to show":void 0}}]),KMCModule.controller("PlayerEditCtrl",["$scope","PlayerData","$routeParams","$filter","menuSvc","PlayerService","apiService","localStorageService","userEntries",function($scope,PlayerData,$routeParams,$filter,menuSvc,PlayerService,apiService,localStorageService,userEntries){if($scope.ks=localStorageService.get("ks"),$scope.playerId=PlayerData.id,$scope.title=$routeParams.id?$filter("i18n")("Edit player"):$filter("i18n")("New  player"),$scope.data=PlayerData,$scope.userEntriesList=[],$scope.userEntries=userEntries,$scope.tags=[],"undefined"!=typeof $scope.data.tags&&$scope.data.tags)for(var tags="string"==typeof $scope.data.tags?$scope.data.tags.split(","):$scope.data.tags,i=0;i<tags.length;i++)$scope.tags.push({id:tags[i],text:tags[i]});menuSvc.registerAction("getTags",function(){return $scope.tags}),angular.forEach($scope.userEntries.objects,function(value){$scope.userEntriesList.push({id:value.id,text:value.name})}),menuSvc.registerAction("listEntries",function(){return $scope.userEntriesList}),menuSvc.registerAction("queryEntries",function(query){var data={results:[]};return console.log(query.term),query.term?(angular.forEach($scope.userEntriesList,function(item){query.term.toUpperCase()===item.text.substring(0,query.term.length).toUpperCase()&&data.results.push(item)}),query.callback(data)):query.callback({results:$scope.userEntriesList})}),parseFloat($scope.data.version)<PlayerService.getRequiredVersion()&&menuSvc.registerAction("update",function(){PlayerService.playerUpdate($scope.data)
}),$scope.previewEntry=$scope.data.previewentry?$scope.data.previewentry.id:"0_ji4qh61l",$scope.$watch("data.previewentry",function(newVal,oldVal){newVal!=oldVal&&($scope.previewEntry=newVal.id,PlayerService.setPreviewEntry($scope.previewEntry),PlayerService.renderPlayer())}),$(document).ready(function(){PlayerService.setPreviewEntry($scope.previewEntry),PlayerService.renderPlayer()})}]),KMCModule.controller("editPageDataCntrl",["$scope",function(){}]),KMCModule.controller("PlayerListCtrl",["apiService","$location","$rootScope","$scope","$filter","$modal","$timeout","$log","$compile","$window","localStorageService","requestNotificationChannel","PlayerService",function(apiService,$location,$rootScope,$scope,$filter,$modal,$timeout,$log,$compile,$window,localStorageService,requestNotificationChannel,PlayerService){requestNotificationChannel.requestStarted("list"),$rootScope.lang="en-US",$scope.search="",$scope.searchSelect2Options={},$scope.currentPage=1,$scope.maxSize=5;var request={"filter:tagsMultiLikeOr":"kdp3","filter:orderBy":"-updatedAt","filter:objTypeEqual":"1","filter:objectType":"KalturaUiConfFilter","filter:creationModeEqual":"2",ignoreNull:"1","page:objectType":"KalturaFilterPager","pager:pageIndex":"1","pager:pageSize":"25",service:"uiConf",action:"list"};apiService.doRequest(request).then(function(data){$scope.data=data.objects,$scope.calculateTotalItems(),PlayerService.cachePlayers(data.objects)}),$scope.filtered=$filter("filter")($scope.data,$scope.search)||[],$scope.playerVersions=[{label:"1.0",url:"",value:"1.0"},{label:"2.0",url:"",value:"2.0"},{label:"2.0.1rc2",url:"",value:"2.0.1"}],$scope.requiredVersion="201",$scope.calculateTotalItems=function(){if($scope.filtered)$scope.totalItems=$scope.filtered.length;else if($scope.data)return $scope.totalItems=$scope.data.length,$scope.totalItems},$scope.checkVersionNeedsUpgrade=function(itemVersion){return itemVersion?(itemVersion=itemVersion.replace(/\./g,""),itemVersion>=$scope.requiredVersion?!1:!0):!1},$scope.showSubTitle=!0,$scope.getThumbnail=function(item){return"undefined"!=typeof item.thumbnailUrl?item.thumbnailUrl:$scope.defaultThumbnailUrl},$scope.defaultThumbnailUrl="img/mockPlayerThumb.png",$scope.$watch("search",function(newValue,oldValue){$scope.showSubTitle=newValue,newValue.length>0?$scope.title=$filter("i18n")("search for")+' "'+newValue+'"':oldValue&&($scope.title=$filter("i18n")("Players list")),$timeout(function(){$scope.calculateTotalItems()},100)}),$scope.oldVersionEditText=$filter("i18n")("Warning this player is out of date. \nSaving changes to this player upgrade, some features and \ndesign may be lost. (read more about upgrading players)"),$scope.goToEditPage=function(item,$event){if($event.preventDefault(),!$scope.checkVersionNeedsUpgrade(item.version))return $location.path("/edit/"+item.id),!1;var msgText=$scope.oldVersionEditText,modal=$modal.open({templateUrl:"template/dialog/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Edit confirmation",message:msgText}}}});modal.result.then(function(result){return result?$location.url("edit/"+item.id):void 0},function(){return $log.info("edit when outdated modal dismissed at: "+new Date)})},$scope.newPlayer=function(){$location.path("/new")},$scope.duplicate=function(item){$scope.data.splice($scope.data.indexOf(item)+1,0,item)},$scope.deletePlayer=function(item){var modal=$modal.open({templateUrl:"template/dialog/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Delete confirmation",message:"Are you sure you want to delete the player?"}}}});modal.result.then(function(result){result&&PlayerService.deletePlayer(item.id).then(function(){$scope.data.splice($scope.data.indexOf(item),1)},function(reason){$modal.open({templateUrl:"template/dialog/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Delete failure",message:reason}}}})})},function(){$log.info("Delete modal dismissed at: "+new Date)})},$scope.update=function(player){PlayerService.playerUpdate(player)}}]);var KMCServices=angular.module("KMC.services",[]);KMCServices.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"]}]),KMCServices.factory("playerCache",["$cacheFactory",function($cacheFactory){return $cacheFactory("playerCache",{capacity:10})}]),KMCServices.factory("sortSvc",[function(){var containers={},sorter={},Container=function(name){this.name=name,this.elements=[],containers[name]=this};return Container.prototype.addElement=function(model){this.elements.push(model)},Container.prototype.callObjectsUpdate=function(){angular.forEach(this.elements,function(model){cl(model.sortVal+" "+model.model)})},Container.prototype.removeElement=function(model){var index=this.elements.indexOf(model);-1!=index&&this.elements.splice(index,1)},sorter.sortScope="",sorter.register=function(containerName,model){var container="undefined"==typeof containers[containerName]?new Container(containerName):containers[containerName];container.addElement(model)},sorter.update=function(newVal,oldVal,model){var oldContainer=containers[oldVal],newContainer=containers[newVal]?containers[newVal]:new Container(newVal);oldContainer&&oldContainer.removeElement(model),newContainer.addElement(model),"object"==typeof sorter.sortScope&&sorter.sortScope.$broadcast("sortContainersChanged")},sorter.getObjects=function(){return containers},sorter.saveOrder=function(containersObj){containers=containersObj,angular.forEach(containers,function(container){container.callObjectsUpdate()})},sorter}]),KMCServices.factory("PlayerService",["$http","$modal","$log","$q","apiService","$filter",function($http,$modal,$log,$q,apiService,$filter){var playersCache=[],currentPlayer={},previewEntry="0_ji4qh61l",playersService={setPreviewEntry:function(id){previewEntry=id},renderPlayer:function(){if(currentPlayer&&"undefined"!=typeof kWidget){var flashvars=$("html").hasClass("IE8")?{wmode:"transparent"}:{};kWidget.embed({targetId:"kVideoTarget",wid:"_"+currentPlayer.partnerId,uiconf_id:currentPlayer.id,flashvars:flashvars,entry_id:previewEntry})}},playerRefresh:function(option){"aspectToggle"==option&&$("#spacer").toggleClass("narrow"),playersService.renderPlayer()},newPlayer:function(){var deferred=$q.defer(),request={service:"uiConf",action:"add","uiConf:objectType":"KalturaUiConf","uiConf:objType":1,"uiConf:creationMode":2};return apiService.doRequest(request).then(function(data){deferred.resolve(data)},function(reason){deferred.reject(reason)}),deferred.promise},getPlayer:function(id){var cache=!1,deferred=$q.defer();if("undefined"!=typeof currentPlayer.id&&(currentPlayer.id==id||"currentEdit"==id)&&(deferred.resolve(currentPlayer),cache=!0),!cache)for(var i=0;i<playersCache.length;i++)playersCache[i].id==id&&(deferred.resolve(playersCache[i]),currentPlayer=playersCache[i],cache=!0);if(!cache){var request={service:"uiConf",action:"get",id:id};apiService.doRequest(request).then(function(result){deferred.resolve(result),currentPlayer=result})}return deferred.promise},cachePlayers:function(playersList){$.isArray(playersList)?playersCache=playersCache.concat(playersList):playersCache.push(playersList)},deletePlayer:function(id){var deferred=$q.defer(),rejectText=$filter("i18n")("Delete action was rejected at API level, perhaps a permission problem?");if("undefined"==typeof id&&currentPlayer&&(id=currentPlayer.id),id){var request={service:"uiConf",action:"delete",id:id};apiService.doRequest(request).then(function(result){deferred.resolve(result)},function(){deferred.reject(rejectText)})}else deferred.reject(rejectText);return deferred.promise},getRequiredVersion:function(){return 2},getPlayers:function(){return $http.get("js/services/allplayers.json")},playerUpdate:function(playerObj){var text="<span>Updating the player -- TEXT MISSING -- current version </span>",modal=$modal.open({templateUrl:"template/dialog/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Update confirmation",message:text+playerObj.version}}}});modal.result.then(function(result){result&&$log.info("update modal confirmed for item version "+playerObj.version+"at: "+new Date)},function(){$log.info("update modal dismissed at: "+new Date)})}};return playersService}]),KMCServices.factory("requestNotificationChannel",["$rootScope",function($rootScope){var _START_REQUEST_="_START_REQUEST_",_END_REQUEST_="_END_REQUEST_",obj={customStart:null};return obj.requestStarted=function(customStart){$rootScope.$broadcast(_START_REQUEST_),customStart&&(obj.customStart=customStart)},obj.requestEnded=function(customStart){if(obj.customStart){if(customStart!=obj.customStart)return;$rootScope.$broadcast(_END_REQUEST_),obj.customStart=null}else $rootScope.$broadcast(_END_REQUEST_)},obj.onRequestStarted=function($scope,handler){$scope.$on(_START_REQUEST_,function(){handler()})},obj.onRequestEnded=function($scope,handler){$scope.$on(_END_REQUEST_,function(){handler()})},obj}]),KMCServices.directive("loadingWidget",["requestNotificationChannel",function(requestNotificationChannel){return{restrict:"EA",scope:{},replace:!0,template:"<div class='loadingOverlay'><a><div id='spinWrapper'></div></a></div>",controller:["$scope","$element",function($scope,$element){$scope.spinner=null,$scope.spinRunning=!1,$scope.opts={lines:15,length:27,width:8,radius:60,corners:1,rotate:0,direction:1,color:"#000",speed:.6,trail:24,shadow:!0,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};var initSpin=function(){$scope.spinner=new Spinner($scope.opts).spin()};$scope.endSpin=function(){$scope.spinner&&$scope.spinner.stop(),$scope.spinRunning=!1},$scope.spin=function(){if(!$scope.spinRunning){var target=$element.find("#spinWrapper");null==$scope.spinner&&initSpin(),$scope.spinner.spin(target[0]),$scope.spinRunning=!0}}}],link:function(scope,element){element.hide();var startRequestHandler=function(){element.show(),scope.spin()},endRequestHandler=function(){element.hide(),scope.endSpin()};requestNotificationChannel.onRequestStarted(scope,startRequestHandler),requestNotificationChannel.onRequestEnded(scope,endRequestHandler)}}}]),KMCServices.factory("editableProperties",["$http",function($http){return $http.get("js/services/editableProperties.json")}]),KMCServices.factory("apiService",["$q","$timeout","$location","localStorageService","playerCache","requestNotificationChannel",function($q,$timeout,$location,localStorageService,playerCache,requestNotificationChannel){return{apiObj:null,getClient:function(){return this.apiObj||(kWidget.api.prototype.type="POST",this.apiObj=new kWidget.api),this.apiObj},unSetks:function(){delete this.apiObj},setKs:function(ks){this.getClient().setKs(ks)},setWid:function(wid){this.getClient().wid=wid},getKey:function(params){var key="";for(var i in params)key+=params[i]+"_";return key},listMedia:function(){var request={service:"media",action:"list"};return this.doRequest(request)},doRequest:function(params){var deferred=$q.defer();requestNotificationChannel.requestStarted();var params_key=this.getKey(params);return playerCache.get(params_key)?deferred.resolve(playerCache.get(params_key)):this.getClient().doRequest(params,function(data){$timeout(function(){data.code?("INVALID_KS"==data.code&&(localStorageService.remove("ks"),$location.path("/login")),requestNotificationChannel.requestEnded(),deferred.reject(data.code)):(playerCache.put(params_key,data),requestNotificationChannel.requestEnded(),deferred.resolve(data))},0)}),deferred.promise}}}]),KMCServices.factory("playerTemplates",["$http",function($http){return{listSystem:function(){return $http.get("http://mrjson.com/data/5263e32d85f7fef869f2a63b/template/list.json")},listUser:function(){return $http.get("http://mrjson.com/data/5263e32d85f7fef869f2a63b/userTemplates/list.json")}}}]);